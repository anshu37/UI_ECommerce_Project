pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Run Tests') {
            steps {
                // Do NOT fail pipeline on test failures
                bat 'mvn clean test || exit 0'
            }
        }

        stage('Publish Cucumber Report') {
            steps {
                cucumber(
                    buildStatus: 'UNSTABLE',
                    jsonReportDirectory: 'target/cucumber-report',
                    fileIncludePattern: '**/cucumber.json'
                )
            }
        }

        stage('Prepare Email Report') {
            steps {
                script {

                    def json = readJSON file: 'target/cucumber-report/cucumber.json'

                    int total = 0
                    int passed = 0
                    int failed = 0
                    int index = 1
                    String tableRows = ""

                    json.each { feature ->

                        String featureFile =
                                feature.uri.replace('\\','/')
                                           .tokenize('/')
                                           .last()

                        feature.elements.each { scenario ->
                            total++

                            // âœ… ONLY source of truth for scenario result
                            boolean scenarioFailed = scenario.result.status == 'failed'

                            String failedStep = "NA"
                            String screenshotLink = "NA"

                            // ðŸ”Ž Find failed step ONLY (do NOT touch status)
                            if (scenarioFailed) {
                                def failedStepObj =
                                        scenario.steps.find { it.result.status == 'failed' }

                                if (failedStepObj != null) {
                                    failedStep =
                                        "${failedStepObj.keyword.trim()} ${failedStepObj.name}"
                                }
                            }

                            if (scenarioFailed) {
                                failed++

                                screenshotLink =
                                  "<a href='${env.BUILD_URL}artifact/reports/screenshots/'>View</a>"

                                tableRows += """
                                <tr style="background-color:#f8d7da;">
                                    <td>${index}</td>
                                    <td>${featureFile}</td>
                                    <td>${scenario.name}</td>
                                    <td><b>FAILED</b></td>
                                    <td>${failedStep}</td>
                                    <td>${screenshotLink}</td>
                                </tr>
                                """
                            } else {
                                passed++

                                tableRows += """
                                <tr style="background-color:#d4edda;">
                                    <td>${index}</td>
                                    <td>${featureFile}</td>
                                    <td>${scenario.name}</td>
                                    <td><b>PASSED</b></td>
                                    <td>NA</td>
                                    <td>NA</td>
                                </tr>
                                """
                            }

                            index++
                        }
                    }

                    // âœ… Jenkins build status
                    if (failed > 0) {
                        currentBuild.result = 'UNSTABLE'
                    }

                    env.EMAIL_BODY = """
                    <h2>UI Automation Execution Summary</h2>

                    <table border="1" cellpadding="8" cellspacing="0">
                        <tr><td><b>Job Name</b></td><td>${env.JOB_NAME}</td></tr>
                        <tr><td><b>Build Number</b></td><td>${env.BUILD_NUMBER}</td></tr>
                        <tr><td><b>Build Status</b></td><td>${currentBuild.currentResult}</td></tr>
                        <tr>
                            <td><b>Build URL</b></td>
                            <td><a href="${env.BUILD_URL}">${env.BUILD_URL}</a></td>
                        </tr>
                        <tr>
                            <td><b>Cucumber Report</b></td>
                            <td>
                              <a href="${env.BUILD_URL}cucumber-html-reports/overview-features.html">
                                  View Cucumber Report
                              </a>
                            </td>
                        </tr>
                    </table>

                    <br/>

                    <h3>Summary</h3>
                    <table border="1" cellpadding="8" cellspacing="0">
                        <tr><td><b>Total Scenarios</b></td><td>${total}</td></tr>
                        <tr style="background-color:#d4edda;"><td><b>Passed</b></td><td>${passed}</td></tr>
                        <tr style="background-color:#f8d7da;"><td><b>Failed</b></td><td>${failed}</td></tr>
                    </table>

                    <br/>

                    <h3>Scenario Details</h3>
                    <table border="1" cellpadding="8" cellspacing="0">
                        <tr>
                            <th>S.No</th>
                            <th>Feature File</th>
                            <th>Scenario</th>
                            <th>Status</th>
                            <th>Failed Step</th>
                            <th>Screenshot</th>
                        </tr>
                        ${tableRows}
                    </table>
                    """
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'reports/**',
                             allowEmptyArchive: true

            emailext(
                subject: "UI Automation | ${env.JOB_NAME} | Build #${env.BUILD_NUMBER} | ${currentBuild.currentResult}",
                body: "${env.EMAIL_BODY}",
                mimeType: 'text/html',
                to: 'anshu.1997mishra@gmail.com'
            )
        }
    }
}
