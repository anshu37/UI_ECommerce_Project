pipeline {
    agent any

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Run Tests') {
            steps {
                bat 'mvn clean test || exit 0'
            }
        }

        stage('Publish Cucumber Report') {
            steps {
                cucumber(
                    buildStatus: 'UNSTABLE',
                    fileIncludePattern: '**/cucumber.json',
                    jsonReportDirectory: 'target/cucumber-report'
                )
            }
        }

        stage('Prepare Email Report') {
            steps {
                script {

                    def json = readJSON file: 'target/cucumber-report/cucumber.json'

                    int total = 0
                    int passed = 0
                    int failed = 0
                    int index = 1
                    String tableRows = ""

                    json.each { feature ->

                        String featureFile = feature.uri.replace('\\','/').tokenize('/').last()

                        feature.elements.each { scenario ->
                            total++

                            boolean scenarioFailed = false
                            String failedStep = "NA"
                            String screenshotLink = "NA"

                            scenario.steps.each { step ->
                                if (step.result.status == 'failed') {
                                    scenarioFailed = true
                                    failedStep = "${step.keyword.trim()} ${step.name}"
                                }
                            }

                            if (scenarioFailed) {
                                failed++
                                screenshotLink =
                                  "<a href='${env.BUILD_URL}artifact/reports/screenshots/'>View</a>"

                                tableRows += """
                                <tr style="background-color:#f8d7da;">
                                    <td>${index}</td>
                                    <td>${featureFile}</td>
                                    <td>${scenario.name}</td>
                                    <td><b>FAILED</b></td>
                                    <td>${failedStep}</td>
                                    <td>${screenshotLink}</td>
                                </tr>
                                """
                            } else {
                                passed++
                                tableRows += """
                                <tr style="background-color:#d4edda;">
                                    <td>${index}</td>
                                    <td>${featureFile}</td>
                                    <td>${scenario.name}</td>
                                    <td><b>PASSED</b></td>
                                    <td>NA</td>
                                    <td>NA</td>
                                </tr>
                                """
                            }

                            index++
                        }
                    }

                    if (failed > 0) {
                        currentBuild.result = 'UNSTABLE'
                    }

                    env.EMAIL_BODY = """
                    <h2>UI Automation Execution Summary</h2>

                    <a href="${env.BUILD_URL}cucumber-html-reports/overview-features.html">
                        View Cucumber Report
                    </a>

                    <br/><br/>

                    <table border="1" cellpadding="8" cellspacing="0">
                        <tr><th>S.No</th><th>Feature</th><th>Scenario</th><th>Status</th><th>Failed Step</th><th>Screenshot</th></tr>
                        ${tableRows}
                    </table>
                    """
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: 'reports/**', allowEmptyArchive: true

            emailext(
                subject: "UI Automation | ${env.JOB_NAME} | Build #${env.BUILD_NUMBER} | ${currentBuild.currentResult}",
                body: "${env.EMAIL_BODY}",
                mimeType: 'text/html',
                to: 'anshu.1997mishra@gmail.com'
            )
        }
    }
}
